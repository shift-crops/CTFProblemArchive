//gcc -D PLAIN hidden.c -o hidden -lcrypto

#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include "aes.h"
#define BUF_SIZE 0x200

#define DEFAULT_IV	"ENJOY,CTF!!"
#define DEFAULT_KEY	"abcdefghijklmnop"

int main();
void end();

char enc[]="\x27\x29\x6c\x52\x80\x4a\x42\x8b\xf7\xe5\x1a\xc7\x64\xf4\xc6\xed\xff\x0f\x4c\x2c\x14\xf2\x16\xce\x2a\xfc\xd5\x99\x17\xdc\x50\x0d\x00\x88\x2d\xe4\x24\xb7\x55\x17\x9a\xe3\x8c\x76\xa2\x46\x74\x87\x03\x6e\x7e\xef\x11\x6f\x24\x21\x00\x52\x4f\xee\xc9\xbb\x56\x25\xfb\x6b\x43\xe1\xcd\x16\xc9\x94\x76\x7f\xc9\xdf\xa6\x72\xd4\x31\xb7\xc7\x4b\x05\xd4\xa1\xf1\x5a\x6a\x4d\xdf\x66\x38\x03\x77\x48\x78\xc4\xba\x2d\xdc\x4f\x0d\x06\x6e\x72\xb3\x7f\x30\xb4\xf4\xe6\x6a\x3f\xa7\xaf\x32\xb7\x67\xc8\x84\xef\x06\x34\xf4\x4e\x15\x92\x64\xd5\x9f\x56\x51\xfa\xf9\x81\x8b\x9a\x8f\xa4\x50\x05\xcc\x06\xca\xba\x35\x62\xc5\x12\xe8\x83\xca\x47\x67\x7f\x9f\x42\xbc\x40\x19\xe0\x85\xe9\x86\x4a\xce\xb0\x4f\x5e\x04\x71\x0c\xbe\x99\x9a\x5c\x94\x61\xc7\xb3\x4f\x56\xac\xaa\x3e\xd9\x01\x3d\xfe\x42\xb7\xce\xef\xd1\x00\x37\x0c\x70\x1b\xe8\x2c\xbd\xb8\xb1\x45\x46\x39\x7a\xf9\xce\x77\xf9\xd2\x96\x5c\xfb\x99\xdb\x24\xc9\x7f\xbc\xa3\xf7\x33\x26\xaa\x59\xda\x3b\x5f\xf3\xea\x4a\x46\x20\xf8\x84\x95\x9a\xa5\xaa\x95\x97\xc0\x91\xd4\x34\x78\x17\xeb\x41\x4c\x68\xeb\x80\xc9\xef\x88\x64\x12\xa8\xfd\xfe\x58\xdc\x81\x8a\xf6\xc1\x38\xd5\x9e\x89\x55\xbb\xae\x16\x21\x7a\x93\x06\x75\x23\xd6\xcc\xc3\x71\x3f\x0b\xd5\x17\x3e\xef\x4f\x30\x53\x26\xe3\x1a\x54\x15\x3d\xfa\x70\x05\xdb\xf8\x05\xfc\x4a\x0e\x7f\x50\xb4\xe4\xe9\xb8\x2e\xdd\x0e\xd1\x48\x82\x68\xaa\xa5\x56\x15\xec\x8d\xcf\x80\x00\xdf\x9d\xf0\xec\xf4\x5e\x5e\x87\x8c\x21\xa8\xce\x31\x5f\xc5\xc2\x68\x14\x47\x07\xd2\x84\x53\xdb\xce\x92\x8a\x69\x2a\x1e\x02\xd9\x79\xf6\x51\xc5\x0f\xf3\x96\x3d\xf5\xfa\xe5\x07\xa2\x0f\x40\x2f\x5b\x10\xdc\x7e\x5d\x0d\x45\x24\x8c\xcc\xd8\xda\x4a\xe6\xff\x71\xb2";

__attribute__((constructor))
init(){
	struct AES aes;
	void *area = (void*)((long)main&0xfffffffffffff000);
	int size;

	size = (int)((void*)end-(void*)main);
	mprotect(area, 0x2000, PROT_READ|PROT_WRITE|PROT_EXEC);

	aes_init(&aes, DEFAULT_IV, DEFAULT_KEY);

#ifdef ENCRYPT
	Encrypt(&aes, (void*)main, size, enc, sizeof(enc));
	asm("nop\nnop");
#else
	Decrypt(&aes, enc, sizeof(enc), (void*)main, size);
#endif

	mprotect(area, 0x2000, PROT_READ|PROT_EXEC);
}

int main(void){
	char buf[BUF_SIZE];
	char *msg[]={"flag : %s\n", "You cannot get flag! Hahaha\n"};

	printf("== HiddenFlag ==\n");
#ifdef PLAIN
	genflag(buf, sizeof(buf));
	printf(msg[0],buf);
#else
	genflag(buf, 0);
	printf(msg[1],buf);
#endif
}

int genflag(char *buf, int len){
	int i;
#ifdef PLAIN
	//char flag[]="FLAG{51mpl3_c1ph3r_";
	char flag[]={0x21, 0x8a, 0x28, 0x34, 0x2a, 0xca, 0x7b, 0x81, 0x59, 0xa1, 0x89, 0xf4, 0x91, 0xca, 0x93, 0x2e, 0x4f, 0xb0, 0x0b, 0xf8, 0x00, 0x00, 0x00, 0x00};
#else
	//char flag[]="w17h_57r4ng3_m3ch4n15m}";
	char flag[]={0x10, 0xf7, 0x5e, 0x1b, 0x0e, 0xca, 0x7d, 0x9e, 0x1d, 0xa3, 0xdd, 0x98, 0xad, 0x96, 0xd0, 0x25, 0x14, 0xf6, 0x3a, 0xc9, 0x2e, 0x85, 0x9a, 0x8d};
#endif

	if(len > sizeof(flag))
		len = sizeof(flag);

	srand(0);
	for(i=0; i<len; i++)
		buf[i]=flag[i]^(char)rand();
	buf[i]='\0';

	return i;
}

void end(){}
